<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build" ToolsVersion="4.0">

  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>

    <AppName Condition=" '$(AppName)'=='' ">.</AppName>
    <PathAdditions Condition=" '$(PathAdditions)'!='' ">$([MSBuild]::Unescape($(PathAdditions))</PathAdditions>

    <InputPath Condition=" '$(InputPath)'=='' ">..\..\..\..</InputPath>

    <OutputPath Condition=" '$(OutDir)'!='' ">$(OutDir)$(AppName)</OutputPath>
    <OutputPath Condition=" '$(OutputPath)'=='' ">dist</OutputPath>

    <TmpOutputPath Condition=" '$(TmpOutputPath)'=='' ">tmp</TmpOutputPath>

    <IsogeoMSBuildTasksPath>$(MSBuildThisFileDirectory)</IsogeoMSBuildTasksPath>
  </PropertyGroup>
  <Import Project="$(IsogeoMSBuildTasksPath)Isogeo.Build.Tasks.targets" />

  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />



  <Target Name="InstallNpmPackages">
    <NodePackageManager Action="Install" WorkingDirectory="$(InputPath)" />

    <Copy
      Condition="Exists('$(InputPath)\package.json')"
      SourceFiles="$(InputPath)\package.json"
      DestinationFiles="$(InputPath)\$(TmpOutputPath)\package.json"
      OverwriteReadOnlyFiles="true"
    />
    <NodePackageManager Action="Dedupe" WorkingDirectory="$(InputPath)" FailOnError="False" />
    <NodeJs
      Arguments="$(APPDATA)/npm/node_modules/npm-flatten/lib/index.js"
      WorkingDirectory="$(InputPath)"
      PathAdditions="$(PathAdditions)"
      FailOnError="False"
     />
    <Move
      Condition="Exists('$(InputPath)\$(TmpOutputPath)\package.json')"
      SourceFiles="$(InputPath)\$(TmpOutputPath)\package.json"
      DestinationFiles="$(InputPath)\package.json"
      OverwriteReadOnlyFiles="true"
    />
    <Delete
      Condition="Exists('$(InputPath)\npm-shrinkwrap.json')"
      Files="$(InputPath)\npm-shrinkwrap.json"
      TreatErrorsAsWarnings="True"
    />
  </Target>



  <!-- Cleans the project -->
  <Target Name="Clean" DependsOnTargets="BeforeClean;CoreClean;AfterClean" />
  <Target Name="CoreClean">
    <NodeJs
      Arguments="$(APPDATA)/npm/node_modules/grunt-cli/bin/grunt --no-color --dest=&quot;$(OutputPath)&quot; clean:complete"
      WorkingDirectory="$(InputPath)"
      PathAdditions="$(PathAdditions)"
     />
  </Target>

  <Target Name="BeforeClean" />
  <Target Name="AfterClean" />



  <!-- Builds the project -->
  <Target
    Name="Build"
    DependsOnTargets="BeforeBuild;CoreBuild;AfterBuild"
  />
  <Target Name="CoreBuild">
    <PropertyGroup>
      <BuildTargets Condition=" '$(BuildType)' == 'Nightly' Or '$(BuildType)' == 'Release' ">release</BuildTargets>
      <BuildTargets Condition=" '$(BuildTargets)' == '' ">build</BuildTargets>
    </PropertyGroup>

    <SetEnvironmentVariable
      Condition="'$(RUBY_BIN)'!=''"
      Variable="PATH"
      Value="$(RUBY_BIN);$(PATH)"
    />
    <NodeJs
      Arguments="$(APPDATA)/npm/node_modules/grunt-cli/bin/grunt --no-color --dest=&quot;$(OutputPath)&quot; $(BuildTargets)"
      WorkingDirectory="$(InputPath)"
      PathAdditions="$(PathAdditions)"
     />
  </Target>

  <Target Name="BeforeBuild" />
  <Target Name="AfterBuild" />
</Project>
