<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build">

  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>

    <AppName Condition=" '$(AppName)'=='' ">.</AppName>
    <PathAdditions Condition=" '$(PathAdditions)'!='' ">$([MSBuild]::Unescape($(PathAdditions))</PathAdditions>

    <InputPath Condition=" '$(InputPath)'=='' ">..\..\..\..</InputPath>

    <OutputPath Condition=" '$(OutDir)'!='' ">$(OutDir)$(AppName)</OutputPath>
    <OutputPath Condition=" '$(OutputPath)'=='' ">dist</OutputPath>

    <TmpOutputPath Condition=" '$(TmpOutputPath)'=='' ">tmp</TmpOutputPath>

    <IsogeoMSBuildTasksPath>$(MSBuildThisFileDirectory)</IsogeoMSBuildTasksPath>
  </PropertyGroup>
  <Import Project="$(IsogeoMSBuildTasksPath)Isogeo.Build.Tasks.targets" />

  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />



  <Target Name="InstallNpmPackages">
    <MakeDir Directories="$(InputPath)\$(TmpOutputPath)\npm-cache" />
    <!-- Sometimes a complete install will fail (https://github.com/npm/npm/issues/10776). Partial installs seem to do the trick in some cases... -->
    <NodePackageManager Action="Install" Only="Production" Cache="$(TmpOutputPath)\npm-cache" WorkingDirectory="$(InputPath)" />
    <NodePackageManager ContinueOnError="WarnAndContinue" Action="Install" Only="Development" Arguments="--no-optional --stack-size=1978" Cache="$(TmpOutputPath)\npm-cache" WorkingDirectory="$(InputPath)" />
    <NodePackageManager Action="Install" Arguments="--no-optional --stack-size=1978" Cache="$(TmpOutputPath)\npm-cache" WorkingDirectory="$(InputPath)" />
  </Target>



  <!-- Cleans the project -->
  <Target Name="Clean" DependsOnTargets="BeforeClean;CoreClean;AfterClean" />
  <Target Name="CoreClean">
    <NodeJs
      Arguments="$(APPDATA)/npm/node_modules/grunt-cli/bin/grunt --no-color --dest=&quot;$(OutputPath)&quot; clean:complete"
      LogStandardErrorAsError="False"
      WorkingDirectory="$(InputPath)"
      PathAdditions="$(PathAdditions)"
     />
  </Target>

  <Target Name="BeforeClean" />
  <Target Name="AfterClean" />



  <!-- Builds the project -->
  <Target
    Name="Build"
    DependsOnTargets="BeforeBuild;CoreBuild;AfterBuild"
  />
  <Target Name="CoreBuild">
    <PropertyGroup>
      <BuildTargets Condition=" '$(BuildType)' == 'Nightly' Or '$(BuildType)' == 'Release' ">release</BuildTargets>
      <BuildTargets Condition=" '$(BuildTargets)' == '' ">build</BuildTargets>
    </PropertyGroup>

    <NodeJs
      Arguments="$(APPDATA)/npm/node_modules/grunt-cli/bin/grunt --no-color --dest=&quot;$(OutputPath)&quot; $(BuildTargets)"
      LogStandardErrorAsError="False"
      WorkingDirectory="$(InputPath)"
      PathAdditions="$(PathAdditions)"
     />
  </Target>

  <Target Name="BeforeBuild" />
  <Target Name="AfterBuild" />
</Project>
